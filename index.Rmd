---
title: "Osa Conservation: Movement ecology data audit"

author:
  - Chris Beirne

site: bookdown::test-bookdown
output: bookdown::gitbook
documentclass: book
biblio-style: apalike
link-citations: yes
---

# Device Status

This document summarizes the movement locations for all active devices within Osa Conservation's movement ecology project. 

```{r c01, echo=F, message=F, include=F}
library(rgdal) 
library(move)
library(dplyr)
library(leaflet)
library(units)
library(sf)
library(viridis)
library(kableExtra)
library(lubridate)
library(plotly)
## Load packages for google drive ----
library(googledrive)
library(purrr)
library(readxl)
library(geosphere)
library(foreach)
library(maptools)

options(googledrive_quiet = TRUE)

# For when the trapping effort file is sorted
# googledrive::drive_auth(path = Sys.getenv("GOOGLE_AUTHENTICATION_CREDENTIALS"))
# 
# ## Find Google Drive folder 'Centre Circle Data & Info'
# data_folder <- drive_ls(path = "08 Databases + Analysis")
# data_path <- "data" 
# dir.create(data_path) 
# drive_download(as_id("14hLi94W4WbDn6jdXahJMnxllOgLpZh-PpIBOWqt9jlc"),
#                path="data/2_vulture_trap_deployments.xlsx")
#capture_dat <- read_excel("data/2_vulture_trap_deployments.xlsx")



# Import passcodes
MOVE_PASS <- Sys.getenv("MOVEBANK_PASSWORD")
MOVE_USE  <- Sys.getenv("MOVEBANK_USERNAME")

loginStored <- movebankLogin(username=MOVE_USE, 
                             password=MOVE_PASS)

# Get animals
# Vultures
animals <-getMovebankAnimals(study=1573471517,login=loginStored)
# Ocelot
tmp <-getMovebankAnimals(study=2526574641,login=loginStored)
# Tapir
tmp2 <- getMovebankAnimals(study=1954804459,login=loginStored)
animals <- rbind(animals, tmp,tmp2)

# For some reason they are duplicated
animals[duplicated(animals)==F,]
# They vary by the field "sensor_type_id"
animals <- animals[animals$sensor_type_id==653 & is.na(animals$sensor_type_id)==F,]

# Clean up the name
animals$animalName <- paste0(sub('\\_.*', '', animals$animalName), "_", sub('\\ .*', '', animals$taxon_canonical_name))
animals$name <- sub('\\_.*', '', animals$animalName)
animals$name[animals$name=="Robin Hood"] <- "Robin.Hood"

# Get last 2 weeks
t <- now("America/Costa_Rica")
start_t <- t-as.difftime(14,units='days')

# Vultures
mov_dat <- getMovebankData(study=1573471517, login=loginStored,  removeDuplicatedTimestamps=TRUE,
                       timestamp_start=start_t)
#OCelot
tmp <- getMovebankData(study=2526574641, login=loginStored,  removeDuplicatedTimestamps=TRUE,
                       timestamp_start=start_t)

#Tapir
tmp2 <- getMovebankData(study=1954804459, login=loginStored,  removeDuplicatedTimestamps=TRUE,
                       timestamp_start=start_t)

mov_dat <- moveStack(mov_dat, tmp, tmp2)

#Add the names
mov_dat$name <- trackId(mov_dat)


# Convert timezone
mov_dat$timestamp <- with_tz(timestamps(mov_dat), tz="America/Costa_Rica")

# all data
#dat <- getMovebankData(study=1573471517, login=loginStored,  removeDuplicatedTimestamps=TRUE)

# Convery move stack to dataframe
dat <- as.data.frame(mov_dat)

# Convert dat to costa rica time
dat$timestamp <- with_tz(dat$timestamp, tzone = "America/Costa_Rica")

# Add the location data
dat <- left_join(dat, animals[, c("tag_id", "animalName")])
# Sort the names out

dat$animalName <- sub('\\_.*', '', dat$animalName)
# Add in the taxonomic group
dat$animalName <- paste0(dat$animalName, "_", sub('\\ .*', '', dat$taxon_canonical_name))

# # Setup the leaflet icon
# leafIcons <- icons(
#   iconUrl = "https://raw.githubusercontent.com/ChrisBeirne/Osa-Conservation-Movement-Ecology-Daily-Report/main/icons/vul_small1.png",
#   iconWidth = 38, iconHeight = 40,
#   iconAnchorX = 22, iconAnchorY = 39,
#   shadowUrl = "https://raw.githubusercontent.com/ChrisBeirne/Osa-Conservation-Movement-Ecology-Daily-Report/main/icons/vul_small_shadow.png",
#   shadowWidth = 38, shadowHeight = 30,
#   shadowAnchorX = 4, shadowAnchorY = 39
# )
# #?iconList()

papa <- makeIcon(
  iconUrl = "https://raw.githubusercontent.com/ChrisBeirne/Osa-Conservation-Movement-Ecology-Daily-Report/main/icons/king_small.png",
  iconWidth = 38, iconHeight = 40,
  iconAnchorX = 22, iconAnchorY = 39,
  shadowUrl = "https://raw.githubusercontent.com/ChrisBeirne/Osa-Conservation-Movement-Ecology-Daily-Report/main/icons/vul_small_shadow.png",
  shadowWidth = 38, shadowHeight = 30,
  shadowAnchorX = 4, shadowAnchorY = 39)

aura <- makeIcon(
  iconUrl = "https://raw.githubusercontent.com/ChrisBeirne/Osa-Conservation-Movement-Ecology-Daily-Report/main/icons/turk_small.png",
  iconWidth = 38, iconHeight = 40,
  iconAnchorX = 22, iconAnchorY = 39,
  shadowUrl = "https://raw.githubusercontent.com/ChrisBeirne/Osa-Conservation-Movement-Ecology-Daily-Report/main/icons/vul_small_shadow.png",
  shadowWidth = 38, shadowHeight = 30,
  shadowAnchorX = 4, shadowAnchorY = 39)

mela <- makeIcon(
  iconUrl = "https://raw.githubusercontent.com/ChrisBeirne/Osa-Conservation-Movement-Ecology-Daily-Report/main/icons/yhv_small.png",
  iconWidth = 38, iconHeight = 40,
  iconAnchorX = 22, iconAnchorY = 39,
  shadowUrl = "https://raw.githubusercontent.com/ChrisBeirne/Osa-Conservation-Movement-Ecology-Daily-Report/main/icons/vul_small_shadow.png",
  shadowWidth = 38, shadowHeight = 30,
  shadowAnchorX = 4, shadowAnchorY = 39)

pardalis <- makeIcon(
  iconUrl = "https://raw.githubusercontent.com/ChrisBeirne/Osa-Conservation-Movement-Ecology-Daily-Report/main/icons/ocelot.png",
  iconWidth = 38, iconHeight = 40,
  iconAnchorX = 22, iconAnchorY = 39)

bairdii <- makeIcon(
  iconUrl = "https://raw.githubusercontent.com/ChrisBeirne/Osa-Conservation-Movement-Ecology-Daily-Report/main/icons/tapir.png",
  iconWidth = 38, iconHeight = 40,
  iconAnchorX = 22, iconAnchorY = 39)

iconSet <- iconList(aura= aura,
                    papa =papa,
                    melambrotus = mela,
                    pardalis = pardalis,
                    bairdii = bairdii)

dat$icon <- sub(".*? ", "", dat$taxon_canonical_name)
unique(dat$icon)

```

*Last data request: `r now(tzone = "America/Costa_Rica")`*

The project currently contains `r length(unique(dat$tag_id))` active tag deployments (defined as being active within the last 14 days). 

```{r  c02, include=F}

# Add a country column
dat$country <- dat$location_lat<0
dat$country[dat$country==T] <- "peru"
dat$country[dat$country==F] <- "costa_rica"
#table(dat$country)

# Costa rica
# Convert to shapefiles
dat <- dat[order(dat$animalName),]

lfc <- do.call(st_sfc,
              lapply(split(dat, dat$name),
                     function(d){st_linestring(as.matrix(d[,c("location_long", "location_lat")]))}))
dat_shp <- st_sf(data.frame(name=levels(factor(dat[,"name"])), geom=lfc))

#plot(dat$location_long[dat$country=="costa_rica"], dat$location_lat[dat$country=="costa_rica"])
#plot(st_geometry(dat_shp), add=T)

sp_dat <- dat[,c("name",    "country", "taxon_canonical_name" )]
sp_dat <- sp_dat[duplicated(sp_dat)==F,]

# add back in the metadata
dat_shp  <- left_join(dat_shp,sp_dat)

```

**Time since last check-in**

```{r  c03, echo=F, include=F}
# Last location and time since present
dat$diff_time <- round(as.numeric(difftime(t, dat$timestamp, units="hours")),1)

last_obs <- dat %>% group_by(name) %>% dplyr::summarize(hours_since_fix=min(diff_time))

last_sum  <- dat %>% 
  group_by(name) %>%
  slice(which.max(timestamp))


tmp <- last_sum[, c("name","taxon_canonical_name","country", "timestamp", "diff_time")]
colnames(tmp)[colnames(tmp)=="diff_time"] <- "time_since_checkin_h"
colnames(tmp)[colnames(tmp)=="timestamp"] <- "last_timestamp"
check_in_summary <- tmp[order(tmp$country, tmp$time_since_checkin_h),]


```


```{r  c04, echo=F, message=F, warning=F}
tmp_col <- check_in_summary$time_since_checkin_h
tmp_col[tmp_col<12]<- 12

check_in_summary[,c(1,2,3,5)] %>%
  kbl() %>%
  kable_styling()  %>%
    column_spec(4, color = "white",
              background = spec_color(tmp_col, begin=0,end = 0.7, direction=-1,
                                      option="D", scale_from = c(12,120)))%>%
  kableExtra::scroll_box(width = "100%")


### Add additional data shown later
check_in_summary$duration <- difftime(check_in_summary$last_timestamp, start_t, "days")

### Total locations Mean eobs battery power, eobs accuracy
tmp_sum <- dat %>% group_by(name) %>% dplyr::summarise(total_obs=n(), mean_batt=mean(eobs_battery_voltage, na.rm=T), loc_accuracy=mean(eobs_horizontal_accuracy_estimate, na.rm=T))
#colnames(dat)

check_in_summary <- left_join(check_in_summary, tmp_sum)
check_in_summary$locs_per_day <- check_in_summary$total_obs/as.numeric(check_in_summary$duration)

```

**Animals not seen for >14 days**

```{r  c05, echo=F}
tmp2 <- animals[!(animals$name %in% tmp$name),]
tmp2$timestamp_end <- with_tz(tmp2$timestamp_end, tzone = "America/Costa_Rica")
#str(tmp2)
tmp2$days_since_check_in<- round(as.numeric(difftime(t, tmp2$timestamp_end, units="days")),1)
tmp2 <- tmp2[order(tmp2$days_since_check_in),]
#row.names(tmp2) <- 1:nrow(tmp2)



tmp2[, c("name", "timestamp_end", "days_since_check_in")] %>%
  kbl() %>%
  kable_styling() %>%
  kableExtra::scroll_box(width = "100%")

```

**Tagging summary**

The proportion of active tags by country:

```{r, echo=F}
library(plotly)

library(dplyr)

fig <- plot_ly()
# All vultures - Countries
fig %>% add_pie(data = dplyr::count(check_in_summary, country), labels = ~country, values = ~n,

          name = "Country")
```

And by species:

```{r, echo=F}
fig <- plot_ly()
# All vultures - Species
fig %>% add_pie(data = dplyr::count(check_in_summary, taxon_canonical_name), labels = ~taxon_canonical_name, values = ~n,

          name = "Species")

```


**Maps**

Last 14 days:

*Costa Rica*

```{r, echo=F}
tmp_cr <- dat[dat$country=="costa_rica",]
tmp_cr_shp <- dat_shp[dat_shp$country=="costa_rica",]


# First lets choose a category to colour
tmp_cr[,"name"] <- factor(tmp_cr[,"name"])
tmp_cr_shp$name <- factor(tmp_cr_shp$name)

col.cat <- turbo(length(levels(tmp_cr[,"name"])))
# Add it to the dataframe
tmp_cr$colours <- col.cat[tmp_cr[,"name"]]
tmp_cr_shp$colours <- col.cat[tmp_cr_shp$name]

```

We currently have `r length(unique(tmp_cr$name))` devices transmitting data in Costa Rica:

```{r, echo=F}
# New map
ids <- tmp_cr_shp$name
names <- sub('\\_.*', '', tmp_cr_shp$name)
i <- 5
m <- leaflet() %>%
  # Add a satellite image layer
  addProviderTiles(providers$Stamen.TonerLite, group="Simple") %>%
  addProviderTiles(providers$Esri.WorldImagery, group="Satellite") %>%
  addProviderTiles(providers$OpenStreetMap.Mapnik, group="OS") #%>%     

  for (i in seq(along=ids))
    {
      m <- m %>%
        addPolylines(data = tmp_cr_shp[i,], color = tmp_cr_shp$colours[i], group = ids[i], weight=3,opacity=0.3)         %>%
        addCircleMarkers(lng=tmp_cr$location_long[tmp_cr$name==ids[i]],
                         lat=tmp_cr$location_lat[tmp_cr$name==ids[i]], 
                         popup=paste(tmp_cr$timestamp[tmp_cr$name==ids[i]]),
                         fillOpacity = 0.3, opacity = 0.5, radius=2, color = tmp_cr_shp$colours[i], group = ids[i], stroke=F) %>%
        addCircleMarkers(lng=last(tmp_cr$location_long[tmp_cr$name==ids[i]]),
                         lat=last(tmp_cr$location_lat[tmp_cr$name==ids[i]]), 
                         popup=paste(last(tmp_cr$timestamp[tmp_cr$name==ids[i]])),
                         fillOpacity = 1, opacity = 1, radius=5, color = tmp_cr_shp$colours[i], group = ids[i], stroke=F) %>% 
        # Add the last point
        addMarkers(lng=last(tmp_cr$location_long[tmp_cr$name==ids[i]]),
                         lat=last(tmp_cr$location_lat[tmp_cr$name==ids[i]]), 
                         popup=paste(last(tmp_cr$local_identifier[tmp_cr$name==ids[i]]),
                                     "<br>Time:",last(tmp_cr$timestamp[tmp_cr$name==ids[i]]),
                                     "<br>Long:",last(tmp_cr$location_long[tmp_cr$name==ids[i]]),
                                     "<br>Lat:",last(tmp_cr$location_lat[tmp_cr$name==ids[i]])),
                   icon = iconSet[tmp_cr$icon[tmp_cr$name==ids[i]][1]], group=ids[i]) #, fillOpacity = 1, opacity = 1, radius=5, color = tmp_cr_shp$colours[i], group = ids[i], stroke=F
    }

  m <- m %>%
      #addLegend(position= "topright", colors=tmp_cr_shp$colours, 
       #         labels=names ,opacity = 0.7, title = "Animals") %>%
      addScaleBar(position="topleft", 
                  options=scaleBarOptions(maxWidth = 100, metric = TRUE, imperial = FALSE, updateWhenIdle = TRUE)) %>%
      addLayersControl(
        baseGroups = c("OS", "Simple", "Satellite"),
        overlayGroups = ids,
        options = layersControlOptions(collapsed = FALSE)
      ) 
  
m 
```

